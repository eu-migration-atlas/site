<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EU Migration Atlas – Compare</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="assets/css/style.css" />

</head>
<body class="compare-page">
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo">
        <img src="assets/logo-atlas.png" alt="European Migration Policy Atlas logo" class="logo-image" />
      </a>

      <nav class="main-nav">
        <a href="index.html" data-page="home">Home</a>
        <a href="countries.html" data-page="countries">Countries</a>
        <a href="compare.html" data-page="compare">Compare</a>
        <a href="assistant.html" data-page="assistant">Atlas AI</a>
        <a href="about.html" data-page="about">About</a>
      </nav>
    </div>
  </header>

<main class="site-main main-content">
  <section class="section section-light">
    <div class="container">
      <header class="section-header">
        <h1>Compare Migration Policies</h1>
        <p>
          Compare two EU Member States side by side using the official highlights from each country profile.
          Pick any two countries to review political context, migration statistics, policy direction, and
          application pathways at a glance.
        </p>
      </header>

      <div class="comparison-panels">
        <article class="comparison-panel compare-panel">
          <div class="country-select-header">
            <label for="compare-country-a">Select country</label>
            <div class="custom-select" id="compare-country-a" data-side="A" data-selected="italy" data-select-type="compare-a">
              <button type="button" class="select-toggle" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="compare-country-a compare-country-a-label">
                <span class="select-label" id="compare-country-a-label">Italy</span>
              </button>
              <ul class="select-options" role="listbox">
                <li data-value="" role="option" aria-selected="false" tabindex="0">Select a country</li>
                <li data-value="austria" role="option" tabindex="0">Austria</li>
                <li data-value="belgium" role="option" tabindex="0">Belgium</li>
                <li data-value="bulgaria" role="option" tabindex="0">Bulgaria</li>
                <li data-value="croatia" role="option" tabindex="0">Croatia</li>
                <li data-value="cyprus" role="option" tabindex="0">Cyprus</li>
                <li data-value="czechia" role="option" tabindex="0">Czechia</li>
                <li data-value="denmark" role="option" tabindex="0">Denmark</li>
                <li data-value="estonia" role="option" tabindex="0">Estonia</li>
                <li data-value="finland" role="option" tabindex="0">Finland</li>
                <li data-value="france" role="option" tabindex="0">France</li>
                <li data-value="germany" role="option" tabindex="0">Germany</li>
                <li data-value="greece" role="option" tabindex="0">Greece</li>
                <li data-value="hungary" role="option" tabindex="0">Hungary</li>
                <li data-value="ireland" role="option" tabindex="0">Ireland</li>
                <li data-value="italy" role="option" aria-selected="true" tabindex="0">Italy</li>
                <li data-value="latvia" role="option" tabindex="0">Latvia</li>
                <li data-value="lithuania" role="option" tabindex="0">Lithuania</li>
                <li data-value="luxembourg" role="option" tabindex="0">Luxembourg</li>
                <li data-value="malta" role="option" tabindex="0">Malta</li>
                <li data-value="netherlands" role="option" tabindex="0">Netherlands</li>
                <li data-value="poland" role="option" tabindex="0">Poland</li>
                <li data-value="portugal" role="option" tabindex="0">Portugal</li>
                <li data-value="romania" role="option" tabindex="0">Romania</li>
                <li data-value="slovakia" role="option" tabindex="0">Slovakia</li>
                <li data-value="slovenia" role="option" tabindex="0">Slovenia</li>
                <li data-value="spain" role="option" tabindex="0">Spain</li>
                <li data-value="sweden" role="option" tabindex="0">Sweden</li>
              </ul>
            </div>
          </div>

          <p class="panel-intro">Highlights for Italy.</p>

          <div class="comparison-panel-metrics">
            <div class="compare-panel-grid">
              <div class="metric-card compare-card" data-metric="political-climate">
                <h3>Political climate</h3>
                <p>
                  The country's current migration stance leans toward balanced cooperation, blending national security considerations with humanitarian obligations. Narrative shifts over election cycles keep the debate active and nuanced within cabinet discussions.
                </p>
              </div>

              <div class="metric-card compare-card" data-metric="migration-statistics">
                <h3>Migration statistics</h3>
                <p>
                  Migration regularly features in talk shows, parliamentary questions, and civic forums. Peaks occur around border incidents or labour market reforms, prompting rapid responses from leading parties and media commentators.
                </p>
              </div>

              <div class="metric-card compare-card" data-metric="current-policies">
                <h3>Current policies</h3>
                <p>
                  Implementation of EU migration and asylum rules generally tracks common standards, with ongoing adjustments to meet new pact obligations. Cooperation with agencies remains steady, supported by technical assistance.
                </p>
              </div>

              <div class="metric-card compare-card" data-metric="application-possibilities">
                <h3>Application possibilities</h3>
                <p>
                  Administrative structures coordinate across ministries and regional authorities, with dedicated budgets for reception and integration. Workforce planning and digital tools are being scaled to manage fluctuating arrivals.
                </p>
              </div>
            </div>
          </div>
        </article>

        <article class="comparison-panel compare-panel">
          <div class="country-select-header">
            <label for="compare-country-b">Select country</label>
            <div class="custom-select" id="compare-country-b" data-side="B" data-selected="germany" data-select-type="compare-b">
              <button type="button" class="select-toggle" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="compare-country-b compare-country-b-label">
                <span class="select-label" id="compare-country-b-label">Germany</span>
              </button>
              <ul class="select-options" role="listbox">
                <li data-value="" role="option" aria-selected="false" tabindex="0">Select a country</li>
                <li data-value="austria" role="option" tabindex="0">Austria</li>
                <li data-value="belgium" role="option" tabindex="0">Belgium</li>
                <li data-value="bulgaria" role="option" tabindex="0">Bulgaria</li>
                <li data-value="croatia" role="option" tabindex="0">Croatia</li>
                <li data-value="cyprus" role="option" tabindex="0">Cyprus</li>
                <li data-value="czechia" role="option" tabindex="0">Czechia</li>
                <li data-value="denmark" role="option" tabindex="0">Denmark</li>
                <li data-value="estonia" role="option" tabindex="0">Estonia</li>
                <li data-value="finland" role="option" tabindex="0">Finland</li>
                <li data-value="france" role="option" tabindex="0">France</li>
                <li data-value="germany" role="option" aria-selected="true" tabindex="0">Germany</li>
                <li data-value="greece" role="option" tabindex="0">Greece</li>
                <li data-value="hungary" role="option" tabindex="0">Hungary</li>
                <li data-value="ireland" role="option" tabindex="0">Ireland</li>
                <li data-value="italy" role="option" tabindex="0">Italy</li>
                <li data-value="latvia" role="option" tabindex="0">Latvia</li>
                <li data-value="lithuania" role="option" tabindex="0">Lithuania</li>
                <li data-value="luxembourg" role="option" tabindex="0">Luxembourg</li>
                <li data-value="malta" role="option" tabindex="0">Malta</li>
                <li data-value="netherlands" role="option" tabindex="0">Netherlands</li>
                <li data-value="poland" role="option" tabindex="0">Poland</li>
                <li data-value="portugal" role="option" tabindex="0">Portugal</li>
                <li data-value="romania" role="option" tabindex="0">Romania</li>
                <li data-value="slovakia" role="option" tabindex="0">Slovakia</li>
                <li data-value="slovenia" role="option" tabindex="0">Slovenia</li>
                <li data-value="spain" role="option" tabindex="0">Spain</li>
                <li data-value="sweden" role="option" tabindex="0">Sweden</li>
              </ul>
            </div>
          </div>

          <p class="panel-intro">Highlights for Germany.</p>

          <div class="comparison-panel-metrics">
            <div class="compare-panel-grid">
              <div class="metric-card compare-card" data-metric="political-climate">
                <h3>Political climate</h3>
                <p>
                  The government frames migration through stability and partnership, balancing border management with international protection duties. Statements from key ministers emphasise predictability and cooperation with neighbouring states.
                </p>
              </div>

              <div class="metric-card compare-card" data-metric="migration-statistics">
                <h3>Migration statistics</h3>
                <p>
                  Media coverage intensifies around legislative updates and migration-related court rulings. Civil society forumsand academic reports feed into televised debates that shape voter perceptions throughout the year.
                </p>
              </div>

              <div class="metric-card compare-card" data-metric="current-policies">
                <h3>Current policies</h3>
                <p>
                  Compliance with EU frameworks is actively managed through inter-ministerial taskforces. Pilot projects with EU agencies test new screening approaches and improve interoperability with partner systems.
                </p>
              </div>

              <div class="metric-card compare-card" data-metric="application-possibilities">
                <h3>Application possibilities</h3>
                <p>
                  Reception networks leverage municipal facilities and partnerships with NGOs. Investment in digital case management aims to streamline procedures and reduce processing backlogs during peak periods.
                </p>
              </div>
            </div>
          </div>
        </article>
      </div>
    </div>
  </section>
</main>


  <footer class="site-footer">
    <div class="container footer-inner">
      <p class="footer-left">
        © 2025 EU Migration Atlas – Cross-Border Migration, Governance &amp; Security
      </p>
      <p class="footer-right">
        Fictional project for DG Migration &amp; Home Affairs (DG HOME)
      </p>
    </div>
  </footer>

  <script src="assets/js/main.js"></script>
  <script>
    const comparePanels = document.querySelectorAll('.comparison-panel');
    comparePanels.forEach(panel => {
      panel.style.overflow = 'visible';
    });

    const compareSelects = document.querySelectorAll('.custom-select');
    const metricFallbacks = {
      'political-climate': 'Select a country to view the political climate overview.',
      'migration-statistics': 'Select a country to view the latest migration statistics context.',
      'current-policies': 'Select a country to view current policy highlights.',
      'application-possibilities': 'Select a country to view application pathway notes.'
    };
    const metricLoading = {
      'political-climate': 'Loading the political climate overview from the country profile.',
      'migration-statistics': 'Loading the migration statistics context from the country profile.',
      'current-policies': 'Loading the current policy highlights from the country profile.',
      'application-possibilities': 'Loading application pathway notes from the country profile.'
    };
    const metricSelectors = {
      'political-climate': { keywords: ['Political climate', 'Political context', 'Politics', 'Political'], },
      'migration-statistics': { keywords: ['Migration statistics', 'Migration trends', 'Statistics', 'Numbers'], },
      'current-policies': { keywords: ['Current policies', 'Policy direction', 'Policies', 'Legislation', 'Frameworks'], },
      'application-possibilities': { keywords: ['Application possibilities', 'Application pathways', 'Asylum procedure', 'Applications', 'Pathways'], }
    };
    const countryCache = new Map();
    let panelRequestId = 0;

    function getCountryName(select) {
      const currentValue = select.dataset.selected || '';
      if (!currentValue) return '';
      const selectedOption = select.querySelector(`.select-options li[data-value="${currentValue}"]`);
      return selectedOption ? selectedOption.textContent.trim() : '';
    }

    async function fetchCountryData(slug) {
      if (!slug) return null;
      if (countryCache.has(slug)) return countryCache.get(slug);

      try {
        const countryUrl = new URL(`countries/${slug}.html`, window.location.href);
        const response = await fetch(countryUrl.toString(), { cache: 'no-store' });
        if (!response.ok) throw new Error(`Failed to load ${slug}`);

        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Name + intro (fallback to <title> if needed)
        const name = (doc.querySelector('.country-title h1')?.textContent
          || doc.querySelector('h1')?.textContent
          || doc.title
          || slug).trim();

        const intro = (doc.querySelector('.page-intro p')?.textContent
          || doc.querySelector('.page-intro')?.textContent
          || '').trim();

        // Heuristic metric extraction: find a relevant heading, then pick the first paragraph after it.
        const metrics = {};

        function pickParagraphAfter(node) {
          if (!node) return '';
          let el = node.nextElementSibling;
          // Walk a bit to find the first paragraph-ish text block
          for (let i = 0; i < 12 && el; i++) {
            const tag = (el.tagName || '').toLowerCase();
            if (tag === 'p') return el.textContent.trim();
            // Some pages wrap content in divs; if a div contains a p, take the first p
            const innerP = el.querySelector && el.querySelector('p');
            if (innerP) return innerP.textContent.trim();
            el = el.nextElementSibling;
          }
          return '';
        }

        function findByKeywords(keywords) {
          const heads = Array.from(doc.querySelectorAll('h2, h3, h4'));
          const lowered = keywords.map(k => k.toLowerCase());
          for (const h of heads) {
            const t = (h.textContent || '').trim().toLowerCase();
            if (!t) continue;
            if (lowered.some(k => t.includes(k))) {
              const para = pickParagraphAfter(h);
              if (para) return para;
            }
          }
          return '';
        }

        Object.entries(metricSelectors).forEach(([metric, config]) => {
          const keywords = (config && config.keywords) ? config.keywords : [];
          let content = '';

          // If a selector exists, try it first (in case some pages match the old class names)
          if (config && config.selector) {
            const el = doc.querySelector(config.selector);
            if (el) {
              // Prefer a paragraph inside the section when possible
              content = (el.querySelector('p')?.textContent || el.textContent || '').trim();
            }
          }

          if (!content && keywords.length) {
            content = findByKeywords(keywords);
          }

          metrics[metric] = content;
        });

        const payload = { name, intro, metrics };
        countryCache.set(slug, payload);
        return payload;
      } catch (error) {
        countryCache.set(slug, null);
        return null;
      }
    }

    async function updatePanelContent(select) {
      const panel = select.closest('.comparison-panel');
      if (!panel) return;
      const countrySlug = select.dataset.selected || '';
      const countryName = getCountryName(select);
      const intro = panel.querySelector('.panel-intro');
      const cards = panel.querySelectorAll('.compare-card');
      const requestId = `${panelRequestId += 1}`;
      panel.dataset.requestId = requestId;

      if (!countrySlug) {
        if (intro) {
          intro.textContent = 'No country selected yet. Choose one to view its profile highlights.';
        }
        cards.forEach(card => {
          const metric = card.dataset.metric;
          const paragraph = card.querySelector('p');
          if (!paragraph || !metric || !metricFallbacks[metric]) return;
          paragraph.textContent = metricFallbacks[metric];
        });
        return;
      }

      if (intro) {
        intro.textContent = countryName
          ? `Loading highlights for ${countryName}...`
          : 'Loading highlights from the selected country profile...';
      }
      cards.forEach(card => {
        const metric = card.dataset.metric;
        const paragraph = card.querySelector('p');
        if (!paragraph || !metric || !metricLoading[metric]) return;
        paragraph.textContent = metricLoading[metric];
      });

      const data = await fetchCountryData(countrySlug);
      if (panel.dataset.requestId !== requestId) return;

      if (!data) {
        if (intro) {
          intro.textContent = 'Unable to load the country profile. Please choose another country.';
        }
        cards.forEach(card => {
          const metric = card.dataset.metric;
          const paragraph = card.querySelector('p');
          if (!paragraph || !metric || !metricFallbacks[metric]) return;
          paragraph.textContent = metricFallbacks[metric];
        });
        return;
      }

      if (intro) {
        intro.textContent = data.intro
          ? `Highlights for ${data.name}. ${data.intro}`
          : `Highlights for ${data.name}.`;
      }

      cards.forEach(card => {
        const metric = card.dataset.metric;
        const paragraph = card.querySelector('p');
        if (!paragraph || !metric) return;
        const content = data.metrics[metric];
        paragraph.textContent = content || metricFallbacks[metric] || '';
      });
    }

    function closeAllSelects(except) {
      compareSelects.forEach(select => {
        if (select === except) return;
        select.classList.remove('open');
        const button = select.querySelector('.select-toggle');
        if (button) button.setAttribute('aria-expanded', 'false');
      });
    }

    function updateDisabledOptions() {
      const selectedValues = Array.from(compareSelects).map(select => select.dataset.selected || '');

      compareSelects.forEach(select => {
        const options = select.querySelectorAll('.select-options li');
        const otherSelected = selectedValues.filter(value => value && value !== (select.dataset.selected || ''));

        options.forEach(option => {
          const value = option.dataset.value || '';
          if (!value) {
            option.classList.remove('is-disabled');
            option.setAttribute('aria-disabled', 'false');
            return;
          }
          const shouldDisable = otherSelected.includes(value);
          option.classList.toggle('is-disabled', shouldDisable);
          option.setAttribute('aria-disabled', shouldDisable ? 'true' : 'false');
        });
      });
    }

    function setSelectedOption(select, option) {
      const value = option.dataset.value || '';
      if (option.classList.contains('is-disabled')) return;

      const label = select.querySelector('.select-label');
      const options = select.querySelectorAll('.select-options li');

      options.forEach(item => item.setAttribute('aria-selected', 'false'));
      option.setAttribute('aria-selected', 'true');

      // Update visible label + selected value (allow clearing selection)
      if (label) label.textContent = option.textContent.trim();
      select.dataset.selected = value;

      closeAllSelects();
      updateDisabledOptions();
      updatePanelContent(select);
    }

    function focusOption(options, target) {
      const optionArray = Array.from(options);
      const index = Math.max(0, optionArray.indexOf(target));
      optionArray[index]?.focus();
    }

    compareSelects.forEach(select => {
      const button = select.querySelector('.select-toggle');
      const options = select.querySelectorAll('.select-options li');
      const currentValue = select.dataset.selected || '';

      options.forEach(option => {
        option.setAttribute('aria-selected', option.dataset.value === currentValue ? 'true' : 'false');
      });
      updatePanelContent(select);

      button.addEventListener('click', () => {
        const isOpen = select.classList.toggle('open');
        button.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen) {
          closeAllSelects(select);
          const selected = select.querySelector('.select-options li[aria-selected="true"]');
          selected?.focus();
        }
      });

      button.addEventListener('keydown', event => {
        if (event.key === 'ArrowDown') {
          event.preventDefault();
          select.classList.add('open');
          button.setAttribute('aria-expanded', 'true');
          closeAllSelects(select);
          const selected = select.querySelector('.select-options li[aria-selected="true"]') || options[0];
          selected?.focus();
        }
      });

      options.forEach(option => {
        option.addEventListener('click', () => setSelectedOption(select, option));
        option.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            setSelectedOption(select, option);
            button.focus();
          }
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            focusOption(options, option.nextElementSibling || options[0]);
          }
          if (event.key === 'ArrowUp') {
            event.preventDefault();
            focusOption(options, option.previousElementSibling || options[options.length - 1]);
          }
          if (event.key === 'Escape') {
            event.preventDefault();
            closeAllSelects();
            button.focus();
          }
        });
      });
    });

    document.addEventListener('click', event => {
      if (!event.target.closest('.custom-select')) closeAllSelects();
    });

    updateDisabledOptions();

    const compareCards = Array.from(document.querySelectorAll('.compare-card'));
    if (compareCards.length) {
      compareCards.forEach(card => {
        const clone = card.cloneNode(true);
        card.replaceWith(clone);
      });

      const refreshedCards = Array.from(document.querySelectorAll('.compare-card'));
      const groups = {};

      refreshedCards.forEach(card => {
        const metric = card.dataset.metric;
        if (!groups[metric]) groups[metric] = [];
        groups[metric].push(card);
      });

      const prefersHover = window.matchMedia('(hover: hover)').matches;
      const isMobile = window.innerWidth < 768;
      let activeMetric = null;

      function collapseActive() {
        if (!activeMetric) return;
        groups[activeMetric].forEach(card => card.classList.remove('cmp-expanded'));
        activeMetric = null;
      }

      function expandMetric(metric) {
        if (activeMetric === metric) return;
        Object.values(groups).forEach(group =>
          group.forEach(card => card.classList.remove('cmp-expanded'))
        );
        groups[metric].forEach(card => card.classList.add('cmp-expanded'));
        activeMetric = metric;
      }

      function isGroupHovered(metric) {
        return groups[metric].some(card => card.matches(':hover'));
      }

      refreshedCards.forEach(card => {
        const metric = card.dataset.metric;
        if (!metric) return;

        if (!isMobile && prefersHover) {
          card.addEventListener('mouseenter', () => expandMetric(metric));
          card.addEventListener('mouseleave', () => {
            window.setTimeout(() => {
              if (!isGroupHovered(metric)) collapseActive();
            }, 40);
          });
        } else {
          card.addEventListener('click', () => {
            const isExpanded = card.classList.contains('cmp-expanded');
            if (isExpanded) {
              collapseActive();
              return;
            }
            expandMetric(metric);
          });
        }
      });

      document.addEventListener('keydown', event => {
        if (event.key === 'Escape') collapseActive();
      });
    }
  </script>
</body>
</html>
